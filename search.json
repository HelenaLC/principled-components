[
  {
    "objectID": "00-setup-Kang18.html",
    "href": "00-setup-Kang18.html",
    "title": "PCR",
    "section": "",
    "text": "library(scran)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(ExperimentHub)\n\n\n\n\n\n# load SCE from EH\neh <- ExperimentHub()\nq <- query(eh, \"Kang18_8vs8\")\nsce <- eh[[q$ah_id]]\n\n\n\n\n\n# keep controls only\nsce <- sce[, sce$stim == \"ctrl\"]\n# drop unassigned cells & multiplets\nsce <- sce[, !is.na(sce$cell)]\nsce <- sce[, sce$multiplets == \"singlet\"]\n# sparsify counts\ncounts(sce) <- as(counts(sce), \"dgCMatrix\")\n# standardize metadata\ncolData(sce) <- DataFrame(\n  cluster = sce$cell,\n  batch = factor(sce$ind))\n# tabulate cell counts\ntable(sce$cluster, sce$batch)\n\n                   \n                     101  107 1015 1016 1039 1244 1256 1488\n  B cells            107   44  453  126   27  116  216  218\n  CD14+ Monocytes    202  209  779  369  126  415  390  295\n  CD4 T cells        293  158  848  422  189 1068 1001 1182\n  CD8 T cells         74   20  179  536   26   58  131   58\n  Dendritic cells     21    8   30   19    9   47   26   43\n  FCGR3A+ Monocytes   80   32  252  115   34   56   69  101\n  Megakaryocytes      11    6   20    8   31   14   14   18\n  NK cells            70   40  177  128   19  105  261  116\n\n\n\nsce <- logNormCounts(sce)\ntbl <- modelGeneVar(sce, block = sce$batch)\nhvg <- rowData(sce)$hvg <- tbl$bio > 0\nsce <- runPCA(sce, subset_row = hvg)\n\n\nthm <- list(\n  theme(aspect.ratio = 1, legend.key.size = unit(0.5, \"lines\")),\n  guides(col = guide_legend(override.aes = list(alpha = 1, size = 2))))\n\n\nplotReducedDim(sce, \"PCA\", colour_by = \"batch\", point_size = 0.1) +\nplotReducedDim(sce, \"PCA\", colour_by = \"cluster\", point_size = 0.1) +\nplot_layout() & thm\n\n\n\n\n\n\n\n\nsaveRDS(sce, \"outs/Kang18.rds\")"
  },
  {
    "objectID": "00-setup-Mereu20.html",
    "href": "00-setup-Mereu20.html",
    "title": "PCR",
    "section": "",
    "text": "library(scran)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(SingleCellExperiment)\n\n\n\n\n\n# download dataset\ncon <- url(paste0(\n  \"https://www.dropbox.com/s/i8mwmyymchx8mn8/\",\n  \"sce.all_classified.technologies.RData?raw=1\"))\noptions(timeout = 180)\nsce <- get(load(con))\nclose(con)\nsce\n\nclass: SingleCellExperiment \ndim: 23381 20237 \nmetadata(0):\nassays(2): counts logcounts\nrownames(23381): TSPAN6 DPM1 ... RPL31P58 RP11-553E24.1\nrowData names(0):\ncolnames(20237): 10X2x5K_64221_AAACCTGCACTTCGAA\n  10X2x5K_64221_AAACCTGCAGTACACT ...\n  SMARTseqFINAL_allLanes_TTGTCGTGTCTCGGAA\n  SMARTseqFINAL_allLanes_TTGTCGTGTGATCCGA\ncolData names(3): nnet2 ident batch\nreducedDimNames(2): UMAP PCA\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\n# standardize metadata\ni <- grep(\"nnet2\", names(colData(sce)))\nnames(colData(sce))[i] <- \"cluster\"\nsce$cluster <- droplevels(sce$cluster)\n# tabulate cell counts\ntable(sce$batch, sce$cluster)\n\n              \n               B cells CD14+ Monocytes CD4 T cells CD8 T cells Dendritic cells\n  C1HT-medium      173             236         267         239              31\n  C1HT-small       104              97         335         338              24\n  CEL-Seq2          83             150         370         125               6\n  Chromium         103             260         566         175              20\n  Chromium(sn)     167             109         444         206              30\n  Drop-Seq         195              66         955         223              16\n  ICELL8           186             392         313         229              33\n  MARS-Seq         131             274         477         204              18\n  Quartz-Seq2       74             369         324         169              18\n  Smart-Seq2        68              37         316          73              11\n  ddSEQ            177             274         589         252              26\n  inDrop            48             167         247          65               6\n  mcSCRB-Seq       148             351         490         224              35\n              \n               FCGR3A+ Monocytes HEK cells NK cells Megakaryocytes\n  C1HT-medium                125      1095       44              6\n  C1HT-small                  37       484      184              3\n  CEL-Seq2                    41       211       96              1\n  Chromium                    41       336      103              0\n  Chromium(sn)                88       228      240              3\n  Drop-Seq                    70       521      214              1\n  ICELL8                     106       584       69             15\n  MARS-Seq                    84       223       65              5\n  Quartz-Seq2                 64       280       34              1\n  Smart-Seq2                  29        61      137              0\n  ddSEQ                       98       590       98              5\n  inDrop                      21       100       31              1\n  mcSCRB-Seq                  93       229      110              4\n\n\nThe published data has been integrated across batches using harmony. We do another round of PCA w/o correction for later comparison comparison.\n\n# basic feature selection\ntbl <- modelGeneVar(sce, block = sce$batch)\nhvg <- rowData(sce)$hvg <- tbl$bio > 0\n# compute uncorrected PCA\nreducedDimNames(sce)[2] <- \"HARMONY\"\ndim <- colnames(reducedDim(sce, 2))\ndim <- gsub(\"_\", \"\", dim)\ncolnames(reducedDim(sce, 2)) <- dim\nsce <- runPCA(sce, subset_row = hvg)\n\n\nthm <- list(\n  theme(aspect.ratio = 1, legend.key.size = unit(0.5, \"lines\")),\n  guides(col = guide_legend(override.aes = list(alpha = 1, size = 2))))\n\n\nplotReducedDim(sce, \"HARMONY\", colour_by = \"cluster\", point_size = 0.1) +\nplotReducedDim(sce, \"UMAP\", colour_by = \"cluster\", point_size = 0.1) +\nplot_layout(guides = \"collect\") & thm\n\n\n\n\n\nplotReducedDim(sce, \"PCA\", colour_by = \"cluster\", point_size = 0.1) +\nplotReducedDim(sce, \"PCA\", colour_by = \"batch\", point_size = 0.1) +\nplot_layout() & thm\n\n\n\n\n\n\n\n\nsaveRDS(sce, \"outs/Mereu20.rds\")"
  },
  {
    "objectID": "00-setup-Zheng17.html",
    "href": "00-setup-Zheng17.html",
    "title": "PCR",
    "section": "",
    "text": "library(scran)\nlibrary(scater)\nlibrary(patchwork)\nlibrary(TENxPBMCData)\nlibrary(SingleCellExperiment)\n\n\n\n\n\nsce <- TENxPBMCData(\"pbmc68k\")\nurl <- paste0(\"https://github.com/10XGenomics/single-cell-3prime-paper/\",\n  \"raw/master/pbmc68k_analysis/68k_pbmc_barcodes_annotation.tsv\")\ndir <- tempdir()\nfnm <- file.path(dir, \"foo.tsv\")\ndownload.file(url, fnm, quiet = TRUE)\nmd <- read.delim(fnm)\n\n\n\n\n\n# store origin t-SNE\ntsne <- md[, grep(\"^TSNE\", names(md))]\nnames(tsne) <- gsub(\"\\\\.\", \"\", names(tsne))\nreducedDim(sce, \"TSNE\") <- as.matrix(tsne)\n# set annotations\nsce$cluster <- md$celltype\n# tabulate cell counts\ntable(sce$cluster)\n\n\n              CD14+ Monocyte                      CD19+ B \n                        2862                         5908 \n                       CD34+               CD4+ T Helper2 \n                         277                           97 \n             CD4+/CD25 T Reg   CD4+/CD45RA+/CD25- Naive T \n                        6187                         1873 \n         CD4+/CD45RO+ Memory                     CD56+ NK \n                        3061                         8776 \n            CD8+ Cytotoxic T CD8+/CD45RA+ Naive Cytotoxic \n                       20773                        16666 \n                   Dendritic \n                        2099 \n\n\n\n# basic feature selection & PCA\nsce <- logNormCounts(sce)\ntbl <- modelGeneVar(sce)\nhvg <- rowData(sce)$hvg <- tbl$bio > 0\nsce <- runPCA(sce, subset_row = hvg)\n\n\nthm <- list(\n  theme(aspect.ratio = 1, legend.key.size = unit(0.5, \"lines\")),\n  guides(col = guide_legend(override.aes = list(alpha = 1, size = 2))))\n\n\nplotReducedDim(sce, \"PCA\", colour_by = \"cluster\", point_size = 0.1) +\nplotReducedDim(sce, \"TSNE\", colour_by = \"cluster\", point_size = 0.1) +\nplot_layout(guides = \"collect\") & thm\n\n\n\n\n\n\n\n\nsaveRDS(sce, \"outs/Zheng17.rds\")"
  },
  {
    "objectID": "01-analysis-Kang18.html",
    "href": "01-analysis-Kang18.html",
    "title": "PCR",
    "section": "",
    "text": "library(dplyr)\nlibrary(scran)\nlibrary(scater)\nlibrary(ggplot2)\nlibrary(patchwork)\n\n\nsource(\"utils.R\")\n\n\n\n\n\n(sce <- readRDS(\"outs/Kang18.rds\"))\n\nclass: SingleCellExperiment \ndim: 35635 12315 \nmetadata(0):\nassays(2): counts logcounts\nrownames(35635): MIR1302-10 FAM138A ... MT-ND6 MT-CYB\nrowData names(3): ENSEMBL SYMBOL hvg\ncolnames: NULL\ncolData names(3): cluster batch sizeFactor\nreducedDimNames(2): TSNE PCA\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\n# pairs of dimension reduction & categories\n# to use for principal component regression\nnames(dr) <- dr <- c(\"PCA\")\nnames(id) <- id <- c(\"batch\", \"cluster\")\ndf <- expand.grid(dr = dr, id = id)\n\n\npcr <- mapply(\n  SIMPLIFY = FALSE,\n  dr = df$dr, id = df$id,\n  \\(dr, id) .pcr(sce, id, dr)) |>\n  do.call(what = rbind) |>\n  `rownames<-`(NULL)\nhead(pcr)\n\n     id  dr  nd         r2         pv       r2pv\n1 batch PCA PC1 0.04531375 15.7184821 0.71226333\n2 batch PCA PC2 0.05288043  2.7946178 0.14778058\n3 batch PCA PC3 0.02367575  1.9401233 0.04593388\n4 batch PCA PC4 0.02458710  1.5769556 0.03877276\n5 batch PCA PC5 0.04572454  0.8855728 0.04049241\n6 batch PCA PC6 0.02589801  0.7876940 0.02039971\n\n\n\ncha <- mapply(\n  SIMPLIFY = FALSE,\n  dr = df$dr, id = df$id,\n  \\(dr, id) .cha(sce, id, dr)) |>\n  do.call(what = rbind) |>\n  `rownames<-`(NULL)\nhead(cha)\n\n   dr    id group  nd     area\n1 PCA batch   101 PC2 9.239007\n2 PCA batch   101 PC3 9.428966\n3 PCA batch   101 PC4 9.720581\n4 PCA batch   101 PC5 8.241781\n5 PCA batch   101 PC6 6.891452\n6 PCA batch   101 PC7 7.162336\n\n\n\n\n\n\n.plot_r2(pcr)\n\n\n\n\n\n.plot_ch(cha, x = \"nd\")\n\n\n\n\n\n.plot_ch(cha, x = \"group\")\n\n\n\n\n\n# indeed, megakaryocytes are \n# all over the place in all PCs\nsub <- sce[, sce$cluster == \"Megakaryocytes\"]\nlapply(seq(2, 13), \\(.) {\n  .plot_dr(sub, id = NULL, nd = c(., 1)) + \n  geom_density2d(col = \"black\")\n}) |> wrap_plots(nrow = 3)"
  },
  {
    "objectID": "01-analysis-Mereu20.html",
    "href": "01-analysis-Mereu20.html",
    "title": "PCR",
    "section": "",
    "text": "library(dplyr)\nlibrary(scran)\nlibrary(scater)\nlibrary(ggplot2)\nlibrary(patchwork)\n\n\nsource(\"utils.R\")\n\n\n\n\n\n(sce <- readRDS(\"outs/Mereu20.rds\"))\n\nclass: SingleCellExperiment \ndim: 23381 20237 \nmetadata(0):\nassays(2): counts logcounts\nrownames(23381): TSPAN6 DPM1 ... RPL31P58 RP11-553E24.1\nrowData names(1): hvg\ncolnames(20237): 10X2x5K_64221_AAACCTGCACTTCGAA\n  10X2x5K_64221_AAACCTGCAGTACACT ...\n  SMARTseqFINAL_allLanes_TTGTCGTGTCTCGGAA\n  SMARTseqFINAL_allLanes_TTGTCGTGTGATCCGA\ncolData names(3): cluster ident batch\nreducedDimNames(3): UMAP HARMONY PCA\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\n# pairs of dimension reduction & categories\n# to use for principal component regression\nnames(dr) <- dr <- c(\"PCA\", \"HARMONY\")\nnames(id) <- id <- c(\"batch\", \"cluster\")\ndf <- expand.grid(dr = dr, id = id)\n\n\npcr <- mapply(\n  SIMPLIFY = FALSE,\n  dr = df$dr, id = df$id,\n  \\(dr, id) .pcr(sce, id, dr)) |>\n  do.call(what = rbind) |>\n  `rownames<-`(NULL)\nhead(pcr)\n\n     id  dr  nd        r2        pv      r2pv\n1 batch PCA PC1 0.3078623 4.5568708 1.4028886\n2 batch PCA PC2 0.4550971 3.6636645 1.6673231\n3 batch PCA PC3 0.4084213 3.5987657 1.4698125\n4 batch PCA PC4 0.3639167 2.5442331 0.9258890\n5 batch PCA PC5 0.1738761 1.2714823 0.2210804\n6 batch PCA PC6 0.8009865 0.9088791 0.7279999\n\n\n\ncha <- mapply(\n  SIMPLIFY = FALSE,\n  dr = df$dr, id = df$id,\n  \\(dr, id) .cha(sce, id, dr)) |>\n  do.call(what = rbind) |>\n  `rownames<-`(NULL)\nhead(cha)\n\n   dr    id       group  nd      area\n1 PCA batch C1HT-medium PC2 15.920001\n2 PCA batch C1HT-medium PC3 15.750506\n3 PCA batch C1HT-medium PC4 13.333174\n4 PCA batch C1HT-medium PC5 12.159930\n5 PCA batch C1HT-medium PC6  6.859515\n6 PCA batch C1HT-medium PC7  9.370730\n\n\n\n.plot_r2(pcr)\n\n\n\n\n\n.plot_ch(cha, ncol = 1)\n\n\n\n\nCloser look at PC7…\n\n.plot_dr(sce, dr = \"HARMONY\", nd = c(7, 1))\n\n\n\n\nLet’s subset the B cell outliers…\n\n# top variable genes within B cells\npcs <- reducedDim(sce, \"HARMONY\")\nbcs <- sce$cluster == \"B cells\"\npc7 <- pcs[, 7] > 10\nsub <- sce[, bcs]\ny <- logcounts(sub)\nsds <- rowSds(y)\navg <- rowMeans(y)\no <- order(sds, decreasing = TRUE)\nrownames(sce)[head(o, 20)]\n\n [1] \"MALAT1\"       \"AC096579.15\"  \"AL121656.4\"   \"CD74\"         \"IGHM\"        \n [6] \"MT-RNR2\"      \"HLA-DRA\"      \"EEF1A1\"       \"RPLP2\"        \"RPS27\"       \n[11] \"RPS29\"        \"B2M\"          \"RPS8\"         \"RPS11\"        \"RP5-857K21.6\"\n[16] \"TPT1\"         \"AFF3\"         \"BACH2\"        \"IGLC2\"        \"MS4A1\"       \n\n\n\n# in principle, could then do some DEA to figure out\n# which genes are being expressed in each subpopulation...\nids <- reducedDim(sub, \"HARMONY\")[, 7] > 10\nmgs <- findMarkers(sub, ids, direct = \"up\")[[2]]\nrownames(mgs)[mgs$Top <= 20]\n\n [1] \"TXNDC5\"        \"JCHAIN\"        \"HSP90B1\"       \"SUB1\"         \n [5] \"MZB1\"          \"MAN1A1\"        \"SEC11C\"        \"ELL2\"         \n [9] \"RP11-302B13.5\" \"FNDC3B\"        \"UBE2J1\"        \"HSPA5\"        \n[13] \"SSR4\"          \"PDIA4\"         \"MYO1D\"         \"SEC61B\"       \n[17] \"IGLL5\"         \"CD38\"          \"GLCCI1\"        \"SSR3\""
  },
  {
    "objectID": "01-analysis-Zheng17.html",
    "href": "01-analysis-Zheng17.html",
    "title": "PCR",
    "section": "",
    "text": "library(dplyr)\nlibrary(scran)\nlibrary(scater)\nlibrary(ggplot2)\nlibrary(patchwork)\n\n\nsource(\"utils.R\")\n\n\n\n\n\n(sce <- readRDS(\"outs/Zheng17.rds\"))\n\nclass: SingleCellExperiment \ndim: 32738 68579 \nmetadata(0):\nassays(2): counts logcounts\nrownames(32738): ENSG00000243485 ENSG00000237613 ... ENSG00000215616\n  ENSG00000215611\nrowData names(4): ENSEMBL_ID Symbol_TENx Symbol hvg\ncolnames: NULL\ncolData names(13): Sample Barcode ... cluster sizeFactor\nreducedDimNames(2): TSNE PCA\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\npcr <- .pcr(sce, id = \"cluster\", dr = \"PCA\", nd = 20)\ncha <- .cha(sce, id = \"cluster\", dr = \"PCA\", nd = 20)\n\n\n\n\n\n.plot_r2(pcr)\n\n\n\n\n\n.plot_ch(cha, x = \"nd\")\n\n\n\n\n\n# same thing but different (one line per PC)\n# should probably scale this according to\n# how important PCs really are or something...\n# still useful though, i.e., the messy clusters pop up \n# across all PCs under consideration, so that's nice...\n.plot_ch(cha, x = \"group\")\n\n\n\n\nCloser look at PC4… though CD34+ are split everywhere (that I looked).\n\n.plot_dr(sce, nd = c(4, 1)) +\n  geom_density2d(col = \"black\")"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "PCR",
    "section": "",
    "text": "Contents\n\nKang18:\n\nsource\n12,315 cells\n8 clusters\n8 biological batches (patients)\n\nMereu20:\n\nsource\n20,237 cells\n9 clusters\n12 technical batches (technologies)\n\nZheng17:\n\nsource\n68,579 cells\n11 clusters\nno batches\n\nall datasets contain PBMCs"
  },
  {
    "objectID": "09-exploratory.html",
    "href": "09-exploratory.html",
    "title": "PCR",
    "section": "",
    "text": "library(sp)\nlibrary(mvtnorm)\n\n\n\n\n\n# simulate bivariate normal with\n# increasing n and all else constant\nns <- round(10^seq(2, 5, l = 100))\nxy <- lapply(ns, rmvnorm, numeric(2))\n# one example...\nplot(xy[[50]], cex = 0.5, lwd = 0.5)\n\n\n\n\n\n# convex hull areas\nas <- mapply(\n  xy = xy, ch = lapply(xy, chull),\n  \\(xy, ch) Polygon(xy[ch, ], TRUE)@area)\n# standard deviations\n# (assuming x were PC1)\nsd <- sapply(xy, \\(.) sd(.[, 2]))\n\n\n# shifting along y for joint visualization\nplot(ns, as, type = \"l\", ylim = c(0, 80),\n  xlab = \"# points\", ylab = \"convex hull area\")\n# jup, as RG pointed out, these are independent of n\nlines(ns, sd+mean(as)/2, col = \"blue\")\n# except for very small scaling by 1/√n seems to work\nlines(ns, as/sqrt(ns)+mean(as), col = \"red\")"
  }
]